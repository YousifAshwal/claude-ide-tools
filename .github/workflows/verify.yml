name: Verify Plugin Compatibility

on:
  # Manual trigger with IDE selection
  workflow_dispatch:
    inputs:
      run_all:
        description: 'Run verification for all IDEs'
        required: false
        default: 'true'
        type: boolean
  # Also run on PRs to master
  pull_request:
    branches:
      - master

jobs:
  build:
    name: Build Plugin
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mcp-server/package-lock.json

      - name: Install MCP Server Dependencies
        working-directory: mcp-server
        run: npm ci

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Make Gradlew Executable
        run: chmod +x ./gradlew

      - name: Build Plugin
        run: ./gradlew buildPlugin

      - name: Upload Plugin Artifact
        uses: actions/upload-artifact@v4
        with:
          name: plugin-artifact
          path: build/distributions/*.zip
          retention-days: 1

  verify:
    name: Verify ${{ matrix.ide.name }}
    runs-on: ubuntu-latest
    needs: build
    # Continue running other IDE checks even if one fails
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        ide:
          - { name: 'IntelliJ IDEA Community', type: 'IC', version: '2024.1' }
          - { name: 'IntelliJ IDEA Ultimate', type: 'IU', version: '2024.1' }
          - { name: 'WebStorm', type: 'WS', version: '2024.1' }
          - { name: 'PyCharm Professional', type: 'PY', version: '2024.1' }
          - { name: 'PyCharm Community', type: 'PC', version: '2024.1' }
          - { name: 'GoLand', type: 'GO', version: '2024.1' }
          - { name: 'PhpStorm', type: 'PS', version: '2024.1' }
          - { name: 'RubyMine', type: 'RM', version: '2024.1' }
          - { name: 'CLion', type: 'CL', version: '2024.1' }
          - { name: 'Rider', type: 'RD', version: '2024.1' }
          - { name: 'RustRover', type: 'RR', version: '2024.1' }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Make Gradlew Executable
        run: chmod +x ./gradlew

      - name: Download Plugin Artifact
        uses: actions/download-artifact@v4
        with:
          name: plugin-artifact
          path: build/distributions/

      - name: Verify against ${{ matrix.ide.name }}
        id: verify
        run: |
          echo "Verifying plugin against ${{ matrix.ide.name }} (${{ matrix.ide.type }} ${{ matrix.ide.version }})"
          ./gradlew verifyPlugin \
            -Pverify.ide.type=${{ matrix.ide.type }} \
            -Pverify.ide.version=${{ matrix.ide.version }} \
            --no-daemon
        continue-on-error: true

      - name: Set verification result
        id: result
        run: |
          if [ "${{ steps.verify.outcome }}" == "success" ]; then
            echo "status=✅ PASSED" >> $GITHUB_OUTPUT
          else
            echo "status=❌ FAILED" >> $GITHUB_OUTPUT
          fi
          echo "ide=${{ matrix.ide.name }}" >> $GITHUB_OUTPUT

      - name: Upload verification result
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.ide.type }}
          path: |
            build/reports/pluginVerifier/
          if-no-files-found: ignore
          retention-days: 7

    outputs:
      result: ${{ steps.result.outputs.status }}

  summary:
    name: Verification Summary
    runs-on: ubuntu-latest
    needs: verify
    if: always()
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          pattern: result-*
          path: results/
          merge-multiple: true

      - name: Generate Summary
        run: |
          echo "## Plugin Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| IDE | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          # Check each IDE result
          for ide in IC IU WS PY PC GO PS RM CL RD RR; do
            if [ -d "results/$ide" ] || [ -f "results/$ide" ]; then
              echo "| $ide | ✅ Verified |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $ide | ⚠️ Check logs |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job logs for details." >> $GITHUB_STEP_SUMMARY

      - name: Check for failures
        if: contains(needs.verify.result, 'failure')
        run: |
          echo "::warning::Some IDE verifications failed. Check the summary above."
